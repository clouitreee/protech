# Cloudflare D1 Integration Documentation

This document details the integration of Cloudflare D1 for the Tech Hilfe Pro NRW website, covering Wrangler configuration, database migrations, and D1 bindings.

## 1. Wrangler Configuration

The `wrangler.jsonc` file configures the Cloudflare Pages project to use D1. Key aspects include:

- **`name`**: Defines the name of the Cloudflare Worker/Pages project.
- **`compatibility_date`**: Specifies the compatibility date for the Worker runtime.
- **`pages_build_output_dir`**: Points to the output directory of the Next.js build, allowing Cloudflare Pages to serve the static assets.
- **`d1_databases`**: An array defining D1 database bindings. In this project, a binding named `DB` is configured for `protech-db`.

```json
{
  "name": "protech-worker",
  "compatibility_date": "2025-10-14",
  "pages_build_output_dir": ".vercel/output/static",
  "d1_databases": [
    { "binding": "DB", "database_name": "protech-db", "database_id": "TBD" }
  ],
  "env": { "production": { "vars": {} }, "preview": { "vars": {} } }
}
```

**Note:** The `database_id` for `protech-db` is currently set to `"TBD"`. This ID must be replaced with the actual ID of your D1 database once it's created in the Cloudflare dashboard.

## 2. Database Migrations

Database schema changes are managed through SQL migration files located in the `migrations/` directory. The initial migration, `0001_init.sql`, sets up the core tables for the application.

- **`migrations/0001_init.sql`**: This file contains `CREATE TABLE` statements for:
  - `customers`
  - `services`
  - `contracts`
  - `tickets`
  - `invoices`
  - `payments`
  - `audit_logs` (for GDPR/NIS2 compliance)

Each table includes relevant columns, primary keys, foreign key constraints, and indexes to ensure data integrity and efficient querying.

To apply migrations, you would typically use the Cloudflare Wrangler CLI:

```bash
wrangler d1 migrations apply protech-db --local # For local development
wrangler d1 migrations apply protech-db --remote # For deployment to Cloudflare
```

## 3. D1 Bindings

The D1 database is exposed to Cloudflare Pages Functions (and Workers) via a binding named `DB`. This binding allows your server-side code to interact with the D1 database.

- **`functions/api/db/health.ts`**: This Pages Function demonstrates the usage of the `DB` binding to perform a simple health check. It executes a `SELECT 1` query to verify database connectivity and returns a 200 status if successful.

```typescript
// Example from functions/api/db/health.ts
interface Env {
  DB: D1Database;
}

export const onRequestGet: PagesFunction<Env> = async (context) => {
  const { DB } = context.env;
  // ... logic to query DB ...
};
```

This setup ensures that your application can securely and efficiently interact with your D1 database within the Cloudflare ecosystem.
